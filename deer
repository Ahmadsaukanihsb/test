-- Layanan yang dibutuhkan
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Daftar hewan peliharaan yang valid (sesuaikan jika perlu)
local VALID_PETS = {
    ["red fox"] = true,
    ["dragonfly"] = true,
    ["raccoon"] = true,
    ["praying mantis"] = true,
    ["deer"] = true -- Pastikan "deer" ada di sini dan namanya cocok dengan nama Tool/Model di game
}

-- Fungsi rekursif untuk mencari hewan peliharaan valid secara mendalam
-- Mengadaptasi logika rekursi dari contoh yang diberikan
local function searchRecursivelyForPet(parentInstance, pathPrefix)
    pathPrefix = pathPrefix or parentInstance.Name
    if not parentInstance then return nil end

    -- print("  Mencari di dalam (logika baru):", pathPrefix) -- Debug: untuk melihat path pencarian

    for _, child in ipairs(parentInstance:GetChildren()) do
        local currentPath = pathPrefix .. " > " .. child.Name
        -- Periksa apakah child adalah Tool atau Model yang valid (sesuai kebutuhan GUI ini)
        if (child:IsA("Tool") or child:IsA("Model")) then
            -- print("    Menemukan item (logika baru):", child.Name, "| Tipe:", child.ClassName, "| Path:", currentPath) -- Debug
            if VALID_PETS[child.Name:lower()] then -- Menggunakan VALID_PETS
                print("      --> Hewan valid ditemukan (logika baru):", child.Name, "di", currentPath)
                return child -- Kembalikan hewan valid pertama yang ditemukan
            end
        end

        -- Jika child adalah Folder atau Model, cari di dalamnya secara rekursif (kondisi rekursi dari contoh)
        if child:IsA("Folder") or child:IsA("Model") then
            local foundPetInChild = searchRecursivelyForPet(child, currentPath) -- Panggilan rekursif
            if foundPetInChild then
                return foundPetInChild -- Kembalikan jika ditemukan di sub-item
            end
        end
    end
    return nil -- Tidak ditemukan di level ini atau sub-levelnya
end

-- Fungsi untuk memeriksa apakah ada hewan peliharaan valid di lokasi yang dapat diakses (dengan pencarian rekursif)
local function findFirstValidPetInAccessibleLocations()
    if not player then
        print("Pemain lokal tidak ditemukan, pencarian dibatalkan.")
        return nil
    end

    print("Mulai pencarian hewan peliharaan valid secara mendalam di lokasi-lokasi penting...")

    -- Lokasi-lokasi penting untuk dicari (ServerStorage dihilangkan karena tidak dapat diakses oleh LocalScript)
    local character = player.Character or player:WaitForChild("Character", 5) -- Tunggu karakter maks 5 detik
    local backpack = player:FindFirstChild("Backpack") or player:WaitForChild("Backpack", 5) -- Tunggu backpack maks 5 detik

    local importantLocations = {
        game:GetService("Workspace"),
        game:GetService("ReplicatedStorage"),
        -- game:GetService("ServerStorage"), -- Tidak dapat diakses oleh LocalScript
        game:GetService("StarterPack"),
        game:GetService("StarterGui"),
        playerGui -- Cari juga di PlayerGui pemain saat ini
    }
    -- Tambahkan karakter dan backpack jika ada
    if character then
        table.insert(importantLocations, character)
    else
        print("Karakter pemain tidak ditemukan atau tidak sempat dimuat untuk pencarian.")
    end
    if backpack then
        table.insert(importantLocations, backpack)
    else
        print("Backpack pemain tidak ditemukan atau tidak sempat dimuat untuk pencarian.")
    end


    for i, location in ipairs(importantLocations) do
        if location then
            print("Memeriksa lokasi:", location:GetFullName())
            local petFound = searchRecursivelyForPet(location) -- Menggunakan fungsi searchRecursivelyForPet yang sudah diupdate
            if petFound then
                print("Hewan peliharaan valid ditemukan di lokasi utama:", location:GetFullName())
                return petFound
            end
        else
            print("Lokasi ke-" .. i .. " adalah nil atau tidak valid.")
        end
    end
    
    print("Tidak ada hewan peliharaan valid yang ditemukan setelah pemeriksaan mendalam di semua lokasi.")
    return nil -- Tidak ada hewan peliharaan valid yang ditemukan
end


-- Fungsi untuk membuat ScreenGui utama
local function createMainGui()
    -- Hapus GUI lama jika ada dengan nama yang sama (opsional, untuk pengujian)
    local oldGui = playerGui:FindFirstChild("KyroscScriptGui")
    if oldGui then
        oldGui:Destroy()
    end

    -- Membuat ScreenGui
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "KyroscScriptGui"
    screenGui.Parent = playerGui
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    screenGui.ResetOnSpawn = false -- Agar GUI tidak hilang saat respawn

    -- Membuat Frame Utama
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, 320, 0, 270) -- Tinggi frame diperbesar menjadi 270
    mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
    mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    mainFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui
    mainFrame.Visible = true -- Pastikan frame utama terlihat saat dibuat

    local frameCorner = Instance.new("UICorner")
    frameCorner.CornerRadius = UDim.new(0, 8)
    frameCorner.Parent = mainFrame

    -- Judul
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Name = "TitleLabel"
    titleLabel.Size = UDim2.new(1, -70, 0, 40) -- Sisakan ruang untuk tombol close dan minimize
    titleLabel.Position = UDim2.new(0, 0, 0, 10)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.Text = "Kyrosc Script (v8.3.1)"
    titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleLabel.TextSize = 18
    titleLabel.Parent = mainFrame

    -- Tombol Close (X)
    local closeButton = Instance.new("TextButton")
    closeButton.Name = "CloseButton"
    closeButton.Size = UDim2.new(0, 25, 0, 25)
    closeButton.Position = UDim2.new(1, -35, 0, 10) -- Kanan atas
    closeButton.AnchorPoint = Vector2.new(1, 0)
    closeButton.BackgroundColor3 = Color3.fromRGB(231, 76, 60) -- Merah
    closeButton.Font = Enum.Font.GothamBold
    closeButton.Text = "X"
    closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeButton.TextSize = 16
    closeButton.Parent = mainFrame
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 4)
    closeCorner.Parent = closeButton

    -- Tombol Minimize (_)
    local minimizeButton = Instance.new("TextButton")
    minimizeButton.Name = "MinimizeButton"
    minimizeButton.Size = UDim2.new(0, 25, 0, 25)
    minimizeButton.Position = UDim2.new(1, -65, 0, 10) -- Di sebelah kiri tombol close
    minimizeButton.AnchorPoint = Vector2.new(1, 0)
    minimizeButton.BackgroundColor3 = Color3.fromRGB(80, 80, 90) -- Abu-abu gelap
    minimizeButton.Font = Enum.Font.GothamBold
    minimizeButton.Text = "_"
    minimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    minimizeButton.TextSize = 16
    minimizeButton.Parent = mainFrame
    local minimizeCorner = Instance.new("UICorner")
    minimizeCorner.CornerRadius = UDim.new(0, 4)
    minimizeCorner.Parent = minimizeButton

    -- Kontainer untuk Ikon Error dan Teks Error
    local errorContainer = Instance.new("Frame")
    errorContainer.Name = "ErrorContainer"
    errorContainer.Size = UDim2.new(0.9, 0, 0, 30)
    errorContainer.Position = UDim2.new(0.5, 0, 0, 60)
    errorContainer.AnchorPoint = Vector2.new(0.5, 0)
    errorContainer.BackgroundTransparency = 1
    errorContainer.Parent = mainFrame

    local errorIcon = Instance.new("TextLabel")
    errorIcon.Name = "ErrorIcon"
    errorIcon.Size = UDim2.new(0, 20, 1, 0)
    errorIcon.BackgroundTransparency = 1
    errorIcon.Font = Enum.Font.GothamBold
    errorIcon.Text = "X"
    errorIcon.TextColor3 = Color3.fromRGB(231, 76, 60)
    errorIcon.TextSize = 20
    errorIcon.TextXAlignment = Enum.TextXAlignment.Center
    errorIcon.TextYAlignment = Enum.TextYAlignment.Center
    errorIcon.Parent = errorContainer

    local errorText = Instance.new("TextLabel")
    errorText.Name = "ErrorText"
    errorText.Size = UDim2.new(1, -25, 1, 0)
    errorText.Position = UDim2.new(0, 25, 0, 0)
    errorText.BackgroundTransparency = 1
    errorText.Font = Enum.Font.GothamSemibold
    errorText.Text = "Required pet not found"
    errorText.TextColor3 = Color3.fromRGB(231, 76, 60)
    errorText.TextSize = 16
    errorText.TextXAlignment = Enum.TextXAlignment.Left
    errorText.TextYAlignment = Enum.TextYAlignment.Center
    errorText.Parent = errorContainer
    
    -- Instruksi
    local instructionsLabel = Instance.new("TextLabel")
    instructionsLabel.Name = "InstructionsLabel"
    instructionsLabel.Size = UDim2.new(0.85, 0, 0, 80) -- Tinggi instruksi diperbesar menjadi 80
    instructionsLabel.Position = UDim2.new(0.5, 0, 0, 100) -- Posisi Y tetap
    instructionsLabel.AnchorPoint = Vector2.new(0.5, 0)
    instructionsLabel.BackgroundTransparency = 1
    instructionsLabel.Font = Enum.Font.Gotham
    instructionsLabel.Text = "Hold one of these pets:\n- Red Fox  - Dragonfly\n- Raccoon  - Praying Mantis\n- Deer\nThen click to start duplicating." -- Menambahkan Deer
    instructionsLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    instructionsLabel.TextSize = 14
    instructionsLabel.TextWrapped = true
    instructionsLabel.LineHeight = 1.2
    instructionsLabel.TextXAlignment = Enum.TextXAlignment.Center
    instructionsLabel.TextYAlignment = Enum.TextYAlignment.Top
    instructionsLabel.Parent = mainFrame

    -- Tombol "Try Again"
    local tryAgainButton = Instance.new("TextButton")
    tryAgainButton.Name = "TryAgainButton"
    tryAgainButton.Size = UDim2.new(0.85, 0, 0, 40)
    tryAgainButton.Position = UDim2.new(0.5, 0, 1, -40) -- Posisi Y offset tetap -40 (relatif terhadap bawah frame)
    tryAgainButton.AnchorPoint = Vector2.new(0.5, 1)
    tryAgainButton.BackgroundColor3 = Color3.fromRGB(231, 76, 60)
    tryAgainButton.Font = Enum.Font.GothamBold
    tryAgainButton.Text = "🔄 Try Again"
    tryAgainButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    tryAgainButton.TextSize = 16
    tryAgainButton.Parent = mainFrame

    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(0, 6)
    buttonCorner.Parent = tryAgainButton

    -- Tombol untuk menampilkan GUI kembali (awalnya tidak terlihat)
    local showGuiButton = Instance.new("TextButton")
    showGuiButton.Name = "ShowKyroscGuiButton"
    showGuiButton.Size = UDim2.new(0, 120, 0, 40) -- Sedikit lebih lebar
    showGuiButton.Position = UDim2.new(0, 15, 0, 15) -- Kiri atas layar
    showGuiButton.BackgroundColor3 = Color3.fromRGB(55, 55, 65)
    showGuiButton.Font = Enum.Font.GothamBold
    showGuiButton.Text = "Show Kyrosc"
    showGuiButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    showGuiButton.TextSize = 14
    showGuiButton.Visible = false -- Awalnya tidak terlihat
    showGuiButton.Parent = screenGui -- Parent adalah screenGui, bukan mainFrame
    local showGuiCorner = Instance.new("UICorner")
    showGuiCorner.CornerRadius = UDim.new(0, 6)
    showGuiCorner.Parent = showGuiButton

    -- Fungsi untuk toggle visibilitas GUI
    local function toggleMainFrame(visible)
        mainFrame.Visible = visible
        showGuiButton.Visible = not visible
    end

    -- Event Handler
    closeButton.MouseButton1Click:Connect(function()
        screenGui:Destroy() -- Hancurkan seluruh GUI
    end)

    minimizeButton.MouseButton1Click:Connect(function()
        toggleMainFrame(false) -- Sembunyikan frame utama
    end)

    showGuiButton.MouseButton1Click:Connect(function()
        toggleMainFrame(true) -- Tampilkan frame utama
    end)
    
    tryAgainButton.MouseButton1Click:Connect(function()
        print("Tombol 'Try Again' diklik! Memeriksa hewan peliharaan...")
        local foundPet = findFirstValidPetInAccessibleLocations() -- Menggunakan fungsi pencarian yang baru

        if foundPet then
            print("Hewan peliharaan valid ditemukan:", foundPet.Name)
            errorText.Text = "Pet '" .. foundPet.Name .. "' found!"
            errorText.TextColor3 = Color3.fromRGB(46, 204, 113) -- Warna hijau untuk sukses
            errorIcon.Text = "✓" -- Ikon centang
            errorIcon.TextColor3 = Color3.fromRGB(46, 204, 113)
        else
            print("Tidak ada hewan peliharaan valid yang dipegang atau ditemukan di lokasi penting.")
            errorText.Text = "Required pet not found"
            errorText.TextColor3 = Color3.fromRGB(231, 76, 60) -- Warna merah
            errorIcon.Text = "X"
            errorIcon.TextColor3 = Color3.fromRGB(231, 76, 60)
        end
    end)

    -- Pengecekan awal saat GUI pertama kali muncul
    local initialPet = findFirstValidPetInAccessibleLocations() -- Menggunakan fungsi pencarian yang baru
    if initialPet then
        errorText.Text = "Pet '" .. initialPet.Name .. "' found!"
        errorText.TextColor3 = Color3.fromRGB(46, 204, 113)
        errorIcon.Text = "✓"
        errorIcon.TextColor3 = Color3.fromRGB(46, 204, 113)
    end

    return screenGui
end

-- Panggil fungsi untuk membuat GUI
createMainGui()
